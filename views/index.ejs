<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Location Tracker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    
    <style>
        
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            max-width: 300px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
        
        
        .user-name {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-name input {
            padding: 5px;
            margin-right: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        
        .user-list {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        
        .user-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .user-item:hover {
            background-color: #f5f5f5;
        }
        
        
        .user-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid #2196F3;
        }
        
        
        .distance-indicator {
            font-weight: bold;
            color: #2196F3;
        }
        
        
        .no-users {
            color: #999;
            font-style: italic;
        }
        
        
        .user-popup h4 {
            margin: 5px 0;
        }
        
        .user-popup p {
            margin: 3px 0;
        }
        
        
        .distance-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            display: none;
        }
        
        .distance-display.active {
            display: block;
        }
        
        
        .clear-selection {
            color: #F44336;
            cursor: pointer;
            margin-left: 5px;
            font-size: 0.9em;
        }
        
        
        .tip {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
            margin-top: 0;
        }
    </style>
</head>
<body>
    
    <div id="map"></div>
    
    
    <div class="info-panel">
        
        <div class="user-name">
            <input type="text" id="usernameInput" placeholder="Your name">
            <button id="updateNameBtn">Update</button>
        </div>
        
        
        <h3>Your Location</h3>
        <p>Latitude: <span id="latitude">-</span></p>
        <p>Longitude: <span id="longitude">-</span></p>
        <p>Speed: <span id="speed">-</span> km/h</p>
        <p>Last Updated: <span id="timestamp">-</span></p>
        <p>Distance Traveled: <span id="distance">0</span> m</p>
        
        
        <div class="distance-display" id="distanceDisplay">
            <h4>Distance Between Points</h4>
            <p><span id="user1Name">-</span> to <span id="user2Name">-</span>: 
            <span id="userDistance" class="distance-indicator">-</span>
            <span class="clear-selection" id="clearSelection">Clear</span></p>
        </div>
        
        
        <div class="user-list">
            <h3>Users & Measurement</h3>
            <p>Click on two points to measure distance</p>
            <p class="tip">Click on the map or select users to measure</p>
            <div id="otherUsers">
                <p class="no-users">No other users online</p>
            </div>
        </div>
    </div>
    
    
    <div class="control-panel">
        <button id="trackButton">Start Tracking</button>
        <button id="resetButton" style="margin-left: 10px; background-color: #f44336;">Reset</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
            
    
    <script src="/socket.io/socket.io.js"></script>
    
    
    <script src="/js/tracking.js"></script>
    
    <script>
        const DEBUG = false;

        const map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let marker = null;
        let path = null;
        let positions = [];
        let timestamps = [];
        let totalDistance = 0;
        let tracking = false;
        let watchId = null;

        let myUsername = "";
        let myLocation = null;
        let mySocketId = null;

        const otherUsers = new Map();
        const otherUserMarkers = new Map();

        let selectedUsers = [];
        let distanceLine = null;
        let distanceLabel = null;

        const socket = io();

        const latElement = document.getElementById('latitude');
        const lngElement = document.getElementById('longitude');
        const speedElement = document.getElementById('speed');
        const timestampElement = document.getElementById('timestamp');
        const distanceElement = document.getElementById('distance');
        const trackButton = document.getElementById('trackButton');
        const resetButton = document.getElementById('resetButton');
        const otherUsersElement = document.getElementById('otherUsers');
        const usernameInput = document.getElementById('usernameInput');
        const updateNameBtn = document.getElementById('updateNameBtn');
        const distanceDisplay = document.getElementById('distanceDisplay');
        const user1NameElement = document.getElementById('user1Name');
        const user2NameElement = document.getElementById('user2Name');
        const userDistanceElement = document.getElementById('userDistance');
        const clearSelectionButton = document.getElementById('clearSelection');

        
        
        updateNameBtn.addEventListener('click', function() {
            const newUsername = usernameInput.value.trim();
            if (newUsername) {
                myUsername = newUsername;
                socket.emit('updateUsername', newUsername);
            }
        });
        
        
        clearSelectionButton.addEventListener('click', function(e) {
            e.stopPropagation();
            clearSelectedUsers();
        });
        
        
        trackButton.addEventListener('click', function() {
            if (!tracking) {
                startTracking();
                this.textContent = 'Stop Tracking';
                tracking = true;
            } else {
                stopTracking();
                this.textContent = 'Start Tracking';
                tracking = false;
            }
        });
        
        
        resetButton.addEventListener('click', function() {
            resetTracking();
        });
        
        
        map.on('click', function(e) {

            const clickedLat = e.latlng.lat;
            const clickedLng = e.latlng.lng;

            const posName = `Position (${formatCoordinate(clickedLat)}, ${formatCoordinate(clickedLng)})`;
            const clickId = `click-${Date.now()}`;

            handleUserSelection(clickId, posName, {
                latitude: clickedLat,
                longitude: clickedLng
            });

            const isSelected = selectedUsers.some(user => user.id === clickId);
            if (isSelected) {
                const clickMarker = L.marker([clickedLat, clickedLng], {
                    icon: createMapIcon('#9C27B0', '')
                }).addTo(map);

                otherUserMarkers.set(clickId, clickMarker);

                clickMarker.bindPopup(`
                    <div class="user-popup">
                        <h4>Clicked Position</h4>
                        <p>Lat: ${formatCoordinate(clickedLat)}</p>
                        <p>Lng: ${formatCoordinate(clickedLng)}</p>
                    </div>
                `).openPopup();
            }
        });

        
        
        function startTracking() {
            if (navigator.geolocation) {

                watchId = navigator.geolocation.watchPosition(
                    handlePosition,
                    handleError,
                    { 
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 10000
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }
        
        
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        
        function resetTracking() {

            positions = [];
            timestamps = [];
            totalDistance = 0;

            distanceElement.textContent = '0';

            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            
            if (path) {
                map.removeLayer(path);
                path = null;
            }

            otherUserMarkers.forEach((marker, id) => {
                if (id.startsWith('click-')) {
                    map.removeLayer(marker);
                    otherUserMarkers.delete(id);
                }
            });

            map.setView([0, 0], 2);

            if (tracking) {
                stopTracking();
                trackButton.textContent = 'Start Tracking';
                tracking = false;
            }

            clearSelectedUsers();
        }
        
        
        function handlePosition(position) {

            const { latitude, longitude } = position.coords;
            const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : '0';
            const timestamp = new Date().toLocaleTimeString();
            const currentTime = Date.now();

            myLocation = { latitude, longitude };

            latElement.textContent = formatCoordinate(latitude);
            lngElement.textContent = formatCoordinate(longitude);
            speedElement.textContent = speed;
            timestampElement.textContent = timestamp;

            if (positions.length > 0) {
                const [prevLat, prevLng] = positions[positions.length - 1];
                const distance = calculateDistance(prevLat, prevLng, latitude, longitude);
                totalDistance += distance;
                distanceElement.textContent = Math.round(totalDistance);
            }

            updateMap(latitude, longitude);

            positions.push([latitude, longitude]);
            timestamps.push(currentTime);

            socket.emit('position', {
                latitude,
                longitude,
                speed,
                timestamp: currentTime,
                formattedTime: timestamp
            });

            updateDistanceBetweenSelectedUsers();
        }
        
        
        function handleError(error) {
            console.error('Error getting location:', error.message);

            if (error.code === error.PERMISSION_DENIED) {

                alert('Location access denied. Please enable location permissions in your browser settings.');
            } else if (tracking) {

                const errorMessage = document.createElement('div');
                errorMessage.className = 'location-error';
                errorMessage.textContent = 'Location temporarily unavailable. Retrying...';
                errorMessage.style.color = '#f44336';
                errorMessage.style.padding = '5px 0';
                errorMessage.style.fontSize = '0.9em';

                const locationInfo = latElement.closest('p');
                if (locationInfo && !document.querySelector('.location-error')) {
                    locationInfo.parentNode.insertBefore(errorMessage, locationInfo);

                    setTimeout(() => {
                        if (errorMessage.parentNode) {
                            errorMessage.parentNode.removeChild(errorMessage);
                        }
                    }, 5000);
                }
            }
        }
        
        
        function updateMap(lat, lng) {
            const newLatLng = [lat, lng];

            if (!marker) {

                marker = L.marker(newLatLng).addTo(map)
                    .bindPopup(`<div class="location-popup">
                        <h4>Your Location</h4>
                        <p>Lat: ${formatCoordinate(lat)}</p>
                        <p>Lng: ${formatCoordinate(lng)}</p>
                    </div>`);
            } else {

                marker.setLatLng(newLatLng);
                marker.getPopup().setContent(`<div class="location-popup">
                    <h4>Your Location</h4>
                    <p>Lat: ${formatCoordinate(lat)}</p>
                    <p>Lng: ${formatCoordinate(lng)}</p>
                </div>`);
            }

            if (path) {
                map.removeLayer(path);
            }
            
            if (positions.length > 1) {
                path = L.polyline(positions, {
                    color: 'blue',
                    weight: 3,
                    opacity: 0.7,
                    className: 'tracking-path'
                }).addTo(map);
            }

            map.setView(newLatLng, 16);
        }

        
        
        function updateOtherUsersList() {

            if (otherUsers.size === 0 && !myLocation) {
                otherUsersElement.innerHTML = '<p class="no-users">No other users online</p>';
                return;
            }

            otherUsersElement.innerHTML = '';

            if (myLocation) {
                const myItem = document.createElement('div');
                myItem.className = 'user-item';

                if (selectedUsers.some(user => user.id === 'me')) {
                    myItem.classList.add('selected');
                }
                
                myItem.innerHTML = `
                    <strong>${myUsername || 'You'} (You)</strong>
                    <div>Last update: ${timestampElement.textContent}</div>
                `;

                myItem.addEventListener('click', () => {
                    handleUserSelection('me', myUsername || 'You', myLocation);
                });
                
                otherUsersElement.appendChild(myItem);
            }

            otherUsers.forEach(user => {
                if (user.socketId !== mySocketId && user.latitude && user.longitude) {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';

                    if (selectedUsers.some(selected => selected.id === user.socketId)) {
                        userItem.classList.add('selected');
                    }
                    
                    userItem.innerHTML = `
                        <strong>${user.username}</strong>
                        <div>Last update: ${user.formattedTime || formatTimestamp(user.lastUpdate)}</div>
                    `;

                    userItem.addEventListener('click', () => {
                        handleUserSelection(user.socketId, user.username, {
                            latitude: user.latitude,
                            longitude: user.longitude
                        });
                    });
                    
                    otherUsersElement.appendChild(userItem);
                }
            });

            if (otherUsersElement.children.length === 0) {
                otherUsersElement.innerHTML = '<p class="no-users">No other users online</p>';
            } else if (otherUsersElement.children.length === 1 && myLocation) {

                const waitMessage = document.createElement('p');
                waitMessage.className = 'no-users';
                waitMessage.textContent = 'Waiting for other users to connect...';
                otherUsersElement.appendChild(waitMessage);
            }
        }

        let otherUsersListScheduled = false;
        function scheduleOtherUsersListUpdate() {
            if (otherUsersListScheduled) return;
            otherUsersListScheduled = true;
            requestAnimationFrame(() => {
                otherUsersListScheduled = false;
                updateOtherUsersList();
            });
        }
        
        
        function handleUserSelection(id, name, location) {

            const index = selectedUsers.findIndex(u => u.id === id);
            
            if (index !== -1) {

                selectedUsers.splice(index, 1);

                if (id.startsWith('click-')) {
                    const marker = otherUserMarkers.get(id);
                    if (marker) {
                        map.removeLayer(marker);
                        otherUserMarkers.delete(id);
                    }
                }
            } else {

                if (selectedUsers.length >= 2) {

                    const oldestId = selectedUsers[0].id;
                    if (oldestId.startsWith('click-')) {
                        const marker = otherUserMarkers.get(oldestId);
                        if (marker) {
                            map.removeLayer(marker);
                            otherUserMarkers.delete(oldestId);
                        }
                    }

                    selectedUsers.shift();
                }

                selectedUsers.push({
                    id: id,
                    name: name,
                    location: location
                });
            }

            scheduleOtherUsersListUpdate();
            updateDistanceBetweenSelectedUsers();
        }
        
        
        function clearSelectedUsers() {

            selectedUsers.forEach(user => {
                if (user.id.startsWith('click-')) {
                    const marker = otherUserMarkers.get(user.id);
                    if (marker) {
                        map.removeLayer(marker);
                        otherUserMarkers.delete(user.id);
                    }
                }
            });

            selectedUsers = [];

            if (distanceLine) {
                map.removeLayer(distanceLine);
                distanceLine = null;
            }
            
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
                distanceLabel = null;
            }

            distanceDisplay.classList.remove('active');

            scheduleOtherUsersListUpdate();
        }
        
        
        function updateDistanceBetweenSelectedUsers() {

            if (distanceLine) {
                map.removeLayer(distanceLine);
                distanceLine = null;
            }
            
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
                distanceLabel = null;
            }

            distanceDisplay.classList.remove('active');

            if (selectedUsers.length !== 2) return;
            
            const user1 = selectedUsers[0];
            const user2 = selectedUsers[1];

            user1NameElement.textContent = user1.name;
            user2NameElement.textContent = user2.name;

            const distance = calculateDistance(
                user1.location.latitude,
                user1.location.longitude,
                user2.location.latitude,
                user2.location.longitude
            );

            userDistanceElement.textContent = Math.round(distance) + ' m';
            distanceDisplay.classList.add('active');

            distanceLine = L.polyline([
                [user1.location.latitude, user1.location.longitude],
                [user2.location.latitude, user2.location.longitude]
            ], {
                color: '#FF5722',
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 10'
            }).addTo(map);

            const midpoint = [
                (user1.location.latitude + user2.location.latitude) / 2,
                (user1.location.longitude + user2.location.longitude) / 2
            ];
            
            const labelIcon = L.divIcon({
                className: 'distance-label',
                html: `<div style="background: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; box-shadow: 0 0 3px rgba(0,0,0,0.3);">${Math.round(distance)} m</div>`,
                iconSize: [80, 20],
                iconAnchor: [40, 10]
            });
            
            distanceLabel = L.marker(midpoint, { icon: labelIcon }).addTo(map);

            const bounds = L.latLngBounds(
                [user1.location.latitude, user1.location.longitude],
                [user2.location.latitude, user2.location.longitude]
            );
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        
        
        function createOrUpdateUserMarker(user) {
            const userLatLng = [user.latitude, user.longitude];

            let userMarker = otherUserMarkers.get(user.socketId);
            
            if (!userMarker) {

                userMarker = L.marker(userLatLng, {
                    icon: createMapIcon('#FF5722', '')
                }).addTo(map);

                otherUserMarkers.set(user.socketId, userMarker);
            } else {

                userMarker.setLatLng(userLatLng);
            }

            userMarker.bindPopup(`
                <div class="user-popup">
                    <h4>${user.username}</h4>
                    <p>Lat: ${formatCoordinate(user.latitude)}</p>
                    <p>Lng: ${formatCoordinate(user.longitude)}</p>
                    <p>Speed: ${user.speed || '0'} km/h</p>
                    <p>Updated: ${user.formattedTime || formatTimestamp(user.lastUpdate)}</p>
                </div>
            `);
        }

        
        
        socket.on('connect', () => {
            mySocketId = socket.id;
            if (DEBUG) console.log('Connected to server with ID:', mySocketId);

            myUsername = "User-" + Math.floor(Math.random() * 10000);
            usernameInput.value = myUsername;
        });
        
        
        socket.on('existingUsers', (users) => {
            if (DEBUG) console.log('Received existing users:', users);
            
            users.forEach(user => {
                if (user.socketId !== mySocketId) {
                    otherUsers.set(user.socketId, user);

                    if (user.latitude && user.longitude) {
                        createOrUpdateUserMarker(user);
                    }
                }
            });
            
            scheduleOtherUsersListUpdate();
        });
        
        
        socket.on('userConnected', (user) => {
            if (DEBUG) console.log('New user connected:', user);
            
            if (user.socketId !== mySocketId) {
                otherUsers.set(user.socketId, user);
                scheduleOtherUsersListUpdate();
            }
        });
        
        
        socket.on('userUpdate', (user) => {
            if (DEBUG) console.log('User updated:', user);
            
            if (user.socketId !== mySocketId) {
                otherUsers.set(user.socketId, user);

                if (user.latitude && user.longitude) {
                    createOrUpdateUserMarker(user);
                }
                
                scheduleOtherUsersListUpdate();

                const selectedIndex = selectedUsers.findIndex(u => u.id === user.socketId);
                if (selectedIndex !== -1) {

                    selectedUsers[selectedIndex].location = {
                        latitude: user.latitude,
                        longitude: user.longitude
                    };

                    updateDistanceBetweenSelectedUsers();
                }
            }
        });
        
        
        socket.on('userDisconnect', (socketId) => {
            if (DEBUG) console.log('User disconnected:', socketId);

            otherUsers.delete(socketId);

            const marker = otherUserMarkers.get(socketId);
            if (marker) {
                map.removeLayer(marker);
                otherUserMarkers.delete(socketId);
            }

            const selectedIndex = selectedUsers.findIndex(u => u.id === socketId);
            if (selectedIndex !== -1) {
                selectedUsers.splice(selectedIndex, 1);
                updateDistanceBetweenSelectedUsers();
            }
            
            scheduleOtherUsersListUpdate();
        });

        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            trackButton.disabled = true;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                map.setView([position.coords.latitude, position.coords.longitude], 16);
            },
            (error) => {

                console.log('Could not get initial location:', error.message);

                if (error.code === error.PERMISSION_DENIED) {
                    alert('Location access denied. Please enable location permissions in your browser settings.');
                }
            },
            { 
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            }
        );
    </script>
</body>
</html>
