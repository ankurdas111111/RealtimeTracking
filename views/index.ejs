<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>Real-time Location Tracker</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/index.css">
</head>
<body data-username="<%= authUser && authUser.username ? authUser.username : '' %>" data-role="<%= authUser && authUser.role ? authUser.role : '' %>">
    <noscript><div style="padding:2rem;text-align:center;font-family:sans-serif;"><h2>JavaScript Required</h2><p>This app requires JavaScript to function. Please enable it in your browser settings.</p></div></noscript>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-big"></div>
        <div style="color:var(--muted);font-size:14px;">Connecting...</div>
    </div>

    <div class="enable-alerts-overlay" id="enableAlertsOverlay">
        <div class="enable-alerts-card">
            <h2>Enable Alerts</h2>
            <p>This app uses sound/vibration for SOS and safety check-ins.</p>
            <p><strong>Tap "Enable Alerts" once</strong> so your browser allows audio.</p>
            <div class="status-actions" style="margin-top:12px;">
                <button class="btn btn-primary" id="enableAlertsBtn" type="button" aria-label="Enable sound and vibration alerts" style="font-size:16px; padding:12px 16px;">Enable Alerts</button>
                <button class="btn btn-muted" id="skipAlertsBtn" type="button" aria-label="Continue without sound alerts" style="font-size:14px; padding:10px 12px;">Continue without sound</button>
            </div>
        </div>
    </div>

    <div class="status-banner" id="statusBanner">
        <div id="statusText"> </div>
        <div class="status-actions" id="statusActions"></div>
    </div>

    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-card alert-flash">
            <h2 id="alertTitle">SOS Alert</h2>
            <div id="alertBody" class="mini"></div>
            <div class="status-actions" id="alertActions" style="margin-top:10px;"></div>
        </div>
    </div>

    <div class="sos-topbar">
        <button class="btn btn-danger sos-btn-big" id="sosBtn" type="button" aria-label="Trigger SOS emergency alert">SOS</button>
        <button class="btn alerts-btn" id="alertsSettingsBtn" type="button" aria-label="Open alerts settings">Alerts</button>
        <button class="btn btn-muted" id="infoPanelBtn" type="button" aria-label="Toggle info panel">Panel</button>
        <button class="btn btn-muted" id="sharePanelBtn" type="button" aria-label="Toggle sharing panel" style="background:rgba(34,197,94,0.28);border:2px solid rgba(255,255,255,0.42);box-shadow:0 12px 22px rgba(34,197,94,0.16);">Share</button>
        <% if (authUser && authUser.role === 'admin') { %>
            <button class="btn btn-muted" id="adminPanelBtn" type="button" aria-label="Toggle admin panel">Admin</button>
        <% } %>
        <button class="btn btn-muted" id="usersPanelBtn" type="button" aria-label="Toggle users panel">Users</button>
    </div>

    <div id="map"></div>

    <div class="info-panel" id="infoPanel">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div class="mini">
                Logged in as <strong><%= authUser.username %></strong><%= authUser.role === 'admin' ? ' (admin)' : '' %>
            </div>
            <form method="POST" action="/logout" style="margin:0;">
                <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                <button class="btn btn-muted" type="submit" aria-label="Log out" style="font-size:12px; padding:6px 10px;">Logout</button>
            </form>
        </div>

        <% const isAdmin = authUser && authUser.role === 'admin'; %>

        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" id="imOkBtn" type="button" aria-label="Send I'm OK check-in">I'm OK</button>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
            <label class="mini" style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="keep48Toggle">
                Keep my last location for 48h after disconnect
            </label>
        </div>

        <% if (isAdmin) { %>
            <div class="panel-section" id="adminPanel">
                <div class="panel-header">
                    <div class="panel-title">Admin Panel</div>
                </div>
                <div class="panel-body" id="adminPanelBody">
                    <div style="display:flex; gap:8px; align-items:center; margin: 8px 0 10px 0; flex-wrap:wrap;">
                        <span class="mini">Apply to:</span>
                        <select id="adminTargetSelect" aria-label="Select target user" style="flex:1; min-width: 180px; padding:6px; border:1px solid #ccc; border-radius:6px;"></select>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
                        <label style="display:flex; gap:6px; align-items:center;">
                            <input type="checkbox" id="autoSosToggle">
                            Auto-SOS
                        </label>
                        <label class="mini" style="display:flex; gap:6px; align-items:center;">
                            No-move (min)
                            <input id="autoNoMoveMin" type="number" min="1" step="1" value="5" aria-label="No movement minutes threshold" style="width:70px; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                        </label>
                        <label class="mini" style="display:flex; gap:6px; align-items:center;">
                            Hard-stop (min)
                            <input id="autoHardStopMin" type="number" min="1" step="1" value="2" aria-label="Hard stop minutes threshold" style="width:70px; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                        </label>
                        <label style="display:flex; gap:6px; align-items:center;">
                            <input type="checkbox" id="geofenceToggle">
                            Geofence
                        </label>
                        <input id="geofenceRadius" type="number" min="100" step="100" value="1500" aria-label="Geofence radius in meters" style="width:90px; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                        <span class="mini">m</span>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
                        <label style="display:flex; gap:6px; align-items:center;">
                            <input type="checkbox" id="checkInToggle">
                            I'm OK check-in
                        </label>
                        <label class="mini" style="display:flex; gap:6px; align-items:center;">
                            Interval (min)
                            <input id="checkInIntervalMin" type="number" min="1" step="1" value="5" aria-label="Check-in interval minutes" style="width:70px; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                        </label>
                        <label class="mini" style="display:flex; gap:6px; align-items:center;">
                            Overdue after (min)
                            <input id="checkInOverdueMin" type="number" min="1" step="1" value="7" aria-label="Overdue after minutes" style="width:80px; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                        </label>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
                        <label class="mini" style="display:flex; gap:6px; align-items:center;">
                            <input type="checkbox" id="keepForeverToggle">
                            Keep selected user forever (no purge)
                        </label>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
                        <button class="btn btn-primary" id="adminApplyBtn" type="button" aria-label="Apply admin settings">Apply / Update</button>
                        <span class="mini">
                            Check-in rule: user must tap "I'm OK" at least every interval; if overdue, admin gets an alert.
                        </span>
                    </div>
                </div>
            </div>
        <% } %>

        <h3>Your Location</h3>
        <p>Latitude: <span id="latitude">-</span></p>
        <p>Longitude: <span id="longitude">-</span></p>
        <p>Speed: <span id="speed">-</span> km/h</p>
        <p>Last Updated: <span id="timestamp">-</span></p>
        <p>Distance Traveled: <span id="distance">0</span> m</p>
    </div>

    <div class="users-panel" id="usersPanel">
        <div class="panel-header">
            <div class="panel-title">Users & Measurement</div>
        </div>
        <div class="panel-body" id="usersPanelBody">
        <div class="distance-display" id="distanceDisplay">
            <h4>Distance Between Points</h4>
            <p><span id="user1Name">-</span> to <span id="user2Name">-</span>:
            <span id="userDistance" class="distance-indicator">-</span>
            <span class="clear-selection" id="clearSelection">Clear</span></p>
        </div>

        <div class="user-list">
            <p>Click on two points to measure distance</p>
                <p class="tip">Tap a user row to focus on map. Use Select (max 2) to measure.</p>
            <div id="otherUsers">
                <p class="no-users">No other users online</p>
                </div>
            </div>
        </div>
    </div>

    <div class="sharing-panel ui-hidden" id="sharingPanel">
        <div class="panel-header">
            <div class="panel-title">Sharing</div>
        </div>
        <div class="panel-body" id="sharingPanelBody">
            <div style="background:rgba(37,99,235,0.06); padding:10px; border-radius:10px; margin-bottom:12px;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <span class="mini" style="font-weight:700;">My Code:</span>
                    <strong id="myShareCode" style="font-size:16px; letter-spacing:1px;"><%= shareCode %></strong>
                    <button class="btn btn-muted small-btn" id="copyShareCodeBtn" type="button" aria-label="Copy share code" style="font-size:11px; padding:5px 8px;">Copy</button>
                </div>
                <div id="myContactInfo" style="margin-top:6px; font-size:12px; color:#64748b;">
                    <% if (userEmail) { %><span>Email: <strong><%= userEmail %></strong></span><% } %>
                    <% if (userMobile) { %><span>Mobile: <strong><%= userMobile %></strong></span><% } %>
                </div>
            </div>
            <div class="panel-section">
                <strong>Rooms</strong>
                <div id="roomsList" style="margin:8px 0;"><p class="mini">No rooms yet</p></div>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                    <input type="text" id="roomNameInput" placeholder="Room name" aria-label="Room name" style="flex:1; min-width:80px; padding:8px; border:1px solid rgba(0,0,0,0.12); border-radius:8px; font-size:13px;">
                    <button class="btn btn-primary small-btn" id="createRoomBtn" type="button" aria-label="Create room" style="padding:8px 12px; font-size:12px;">Create</button>
                </div>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                    <input type="text" id="joinRoomInput" placeholder="Room code" aria-label="Room code to join" style="flex:1; min-width:80px; padding:8px; border:1px solid rgba(0,0,0,0.12); border-radius:8px; font-size:13px; text-transform:uppercase;">
                    <button class="btn btn-primary small-btn" id="joinRoomBtn" type="button" aria-label="Join room" style="padding:8px 12px; font-size:12px;">Join</button>
                </div>
            </div>
            <div class="panel-section">
                <strong>Contacts</strong>
                <div id="contactsList" style="margin:8px 0;"><p class="mini">No contacts yet</p></div>
                <div style="margin-top:6px;">
                    <p class="mini" style="margin-bottom:4px; color:#64748b;">Add by email or mobile:</p>
                    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="addContactByValueInput" placeholder="Email or mobile number" aria-label="Email or mobile to add contact" style="flex:1; min-width:120px; padding:8px; border:1px solid rgba(0,0,0,0.12); border-radius:8px; font-size:13px;">
                        <button class="btn btn-primary small-btn" id="addContactByValueBtn" type="button" aria-label="Add contact by email or mobile" style="padding:8px 12px; font-size:12px;">Add</button>
                    </div>
                </div>
                <div style="margin-top:6px;">
                    <p class="mini" style="margin-bottom:4px; color:#94a3b8;">Or add by share code:</p>
                    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="addContactInput" placeholder="Share code" aria-label="Share code to add contact" style="flex:1; min-width:80px; padding:8px; border:1px solid rgba(0,0,0,0.12); border-radius:8px; font-size:13px; text-transform:uppercase;">
                        <button class="btn btn-primary small-btn" id="addContactBtn" type="button" aria-label="Add contact by share code" style="padding:8px 12px; font-size:12px;">Add</button>
                    </div>
                </div>
            </div>
            <div class="panel-section">
                <strong>Live Sharing</strong>
                <p class="mini" style="margin:4px 0 8px;">Generate a public link anyone can open (no login).</p>
                <div id="liveLinksList" style="margin:8px 0;"><p class="mini">No active links</p></div>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                    <button class="btn btn-muted small-btn" id="liveLink1h" type="button" aria-label="Create 1 hour live link" style="padding:6px 10px; font-size:11px;">1h</button>
                    <button class="btn btn-muted small-btn" id="liveLink6h" type="button" aria-label="Create 6 hour live link" style="padding:6px 10px; font-size:11px;">6h</button>
                    <button class="btn btn-muted small-btn" id="liveLink24h" type="button" aria-label="Create 24 hour live link" style="padding:6px 10px; font-size:11px;">24h</button>
                    <button class="btn btn-primary small-btn" id="liveLinkForever" type="button" aria-label="Create permanent live link" style="padding:6px 10px; font-size:11px;">Until I stop</button>
                </div>
            </div>
            <div id="sharingOnboarding" class="panel-section" style="display:none;">
                <p class="mini" style="font-style:italic; color:#64748b;">You're not sharing with anyone yet. Create a room or exchange share codes to start seeing others on the map.</p>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button id="trackButton" aria-label="Start or stop location tracking">Start Tracking</button>
        <button id="resetButton" aria-label="Reset tracking data" style="margin-left: 10px; background-color: #f44336;">Reset</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/tracking.js"></script>
    <script src="/js/app.js"></script>
</body>
</html>
